{{ define "matrix" }}
<div class="flex flex-col items-center w-full max-w-5xl">
    <div class="flex justify-between items-center w-full mb-6">
        <div class="flex flex-wrap gap-2 p-1.5 bg-slate-800/80 rounded-xl border border-slate-700/50 backdrop-blur-md">
            <button onclick="setMetric('combined_score')" id="btn-combined_score"
                class="metric-btn px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all duration-200">
                Fuerza
            </button>
            <button onclick="setMetric('truco_mean')" id="btn-truco_mean"
                class="metric-btn px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all duration-200">
                Truco
            </button>
            <button onclick="setMetric('envido_mean')" id="btn-envido_mean"
                class="metric-btn px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all duration-200">
                Envido
            </button>
            <button onclick="setMetric('count')" id="btn-count"
                class="metric-btn px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all duration-200">
                Probabilidad
            </button>
        </div>

        <div
            class="flex items-center gap-3 bg-slate-800/80 p-1.5 rounded-xl border border-slate-700/50 backdrop-blur-md h-fit">
            <button onclick="toggleMatrix()" id="envido-toggle" hx-target="#tracker-grid"
                class="relative inline-flex h-6 w-11 items-center rounded-full transition-all duration-300 bg-blue-600">
                <span id="envido-toggle-dot"
                    class="inline-block h-4 w-4 transform rounded-full bg-slate-200 transition-all duration-300 translate-x-6"></span>
            </button>
            <span id="label-com"
                class="text-[10px] font-bold tracking-widest text-blue-400 pr-2 transition-colors duration-300">
                COMPLETA 14x14
            </span>
        </div>
    </div>

    <div class="grid grid-cols-[repeat(14,minmax(0,1fr))] gap-px bg-slate-900 border border-slate-900 rounded-lg overflow-hidden shadow-2xl w-full"
        id="matrix">
        <!-- JS will populate this -->
    </div>
</div>

<script>
    let pairStats = {};
    let currentMetric = 'combined_score';
    let showFullMatrix = true;

    function toggleMatrix() {
        showFullMatrix = !showFullMatrix;
        const toggle = document.getElementById('envido-toggle');
        const dot = document.getElementById('envido-toggle-dot');
        const textLabel = document.getElementById('label-com');

        if (showFullMatrix) {
            toggle.classList.remove('bg-slate-700');
            toggle.classList.add('bg-blue-600');
            dot.classList.remove('translate-x-1');
            dot.classList.add('translate-x-6');
            textLabel.classList.add('text-blue-400');
            textLabel.classList.remove('text-slate-400');
            textLabel.innerText = 'COMPLETA 14x14';
        } else {
            toggle.classList.remove('bg-blue-600');
            toggle.classList.add('bg-slate-700');
            dot.classList.remove('translate-x-6');
            dot.classList.add('translate-x-1');
            textLabel.classList.remove('text-blue-400');
            textLabel.classList.add('text-slate-400');
            textLabel.innerText = 'TRIANGULO 14x14';
        }
        initMatrix();
    }

    const METRIC_CONFIGS = {
        'combined_score': { key: 'combined_mean', range: 1, label: 'Combined Score' },
        'truco_mean': { key: 'truco_mean', range: 1, label: 'Truco Mean' },
        'envido_mean': { key: 'envido_mean', range: 33, label: 'Envido Mean' },
        'count': { key: 'count', range: 300, label: 'Count' }
    };

    const COLOR_CONFIG = {
        lowScore: [0, 85, 50],
        highScore: [120, 100, 50],
        textThreshold: 0.6
    };

    function setMetric(metric) {
        currentMetric = metric;
        // Update button styles
        document.querySelectorAll('.metric-btn').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-900/40');
            btn.classList.add('text-slate-400', 'hover:text-slate-200', 'hover:bg-slate-700/50');
        });
        const activeBtn = document.getElementById('btn-' + metric);
        if (activeBtn) {
            activeBtn.classList.remove('text-slate-400', 'hover:text-slate-200', 'hover:bg-slate-700/50');
            activeBtn.classList.add('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-900/40');
        }
        initMatrix();
    }

    // score: value to map color to
    // range: max value score can have
    //   If score is not evenly distributed try with higher or lower range,
    //   or pass 1 if value is already normalized
    function getColorForScore(score, range) {
        if (score === undefined || isNaN(score)) {
            return 'hsl(220, 15%, 30%)';
        }
        const [h1, s1, l1] = COLOR_CONFIG.lowScore;
        const [h2, s2, l2] = COLOR_CONFIG.highScore;
        const t = Math.min(Math.max(score / range, 0), 1);
        const h = h1 + (h2 - h1) * t;
        const s = s1 + (s2 - s1) * t;
        const l = l1 + (l2 - l1) * t;
        return `hsl(${h}, ${s}%, ${l}%)`;
    }

    function updateMatrixStats(newStats) {
        if (!newStats) return;
        pairStats = newStats;
        setMetric(currentMetric);
    }

    function formatValue(val, precision = 2) {
        if (val === undefined || isNaN(val)) return 'N/A';
        return val.toFixed(precision);
    }

    function updateStatsPanel(key, isEnvido) {
        const data = pairStats[key];
        const placeholder = document.getElementById('stats-placeholder');
        const content = document.getElementById('stats-content');

        if (!data) {
            placeholder.classList.remove('hidden');
            content.classList.add('hidden');
            return;
        }

        placeholder.classList.add('hidden');
        content.classList.remove('hidden');

        const [c1, c2, env] = key.split(' ');

        content.innerHTML = `
            <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden shadow-xl animate-in fade-in slide-in-from-right-4 duration-300">
                <div class="bg-gradient-to-r from-blue-600/20 to-emerald-600/20 p-6 border-b border-slate-700">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-slate-400 text-xs font-bold uppercase tracking-wider">Mejor par</span>
                        <span class="bg-slate-700 text-slate-300 text-[10px] px-2 py-0.5 rounded-full font-mono">${data.count} manos posibles</span>
                    </div>
                    <h2 class="text-4xl font-black text-white flex items-center gap-3 mb-3">
                        ${c1}<span class="text-slate-500 font-light">&</span>${c2}
                    </h2>
                    <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/30">
                        <p class="text-slate-500 text-[10px] uppercase font-bold mb-1">Resumen (envido y truco)</p>
                        <p class="text-xl font-bold text-slate-200">${formatValue(data.combined_mean, 3)}</p>
                    </div>
                </div>
                
                <div class="p-6 space-y-6">
                    <section>
                        <h3 class="text-blue-400 text-xs font-bold uppercase tracking-widest mb-4 flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span>
                            Truco
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/30">
                                <p class="text-slate-500 text-[10px] uppercase font-bold mb-1">Promedio</p>
                                <p class="text-xl font-bold text-slate-200">${formatValue(data.truco_mean, 3)}</p>
                            </div>
                            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/30">
                                <p class="text-slate-500 text-[10px] uppercase font-bold mb-1">Mediana</p>
                                <p class="text-xl font-bold text-slate-200">${formatValue(data.truco_median, 3)}</p>
                            </div>
                            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/30">
                                <p class="text-slate-500 text-[10px] uppercase font-bold mb-1">Max</p>
                                <p class="text-xl font-bold text-emerald-400">${formatValue(data.truco_max, 3)}</p>
                            </div>
                            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/30">
                                <p class="text-slate-500 text-[10px] uppercase font-bold mb-1">Min</p>
                                <p class="text-xl font-bold text-red-400">${formatValue(data.truco_min, 3)}</p>
                            </div>
                        </div>
                    </section>

                    <!-- Divider -->
                    <div class="border-t border-slate-700/50"></div>

                    <section>
                        <h3 class="text-emerald-400 text-xs font-bold uppercase tracking-widest mb-4 flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                            Envido
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/30">
                                <p class="text-slate-500 text-[10px] uppercase font-bold mb-1">Promedio</p>
                                <p class="text-xl font-bold text-slate-200">${formatValue(data.envido_mean, 1)}</p>
                            </div>
                            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/30">
                                <p class="text-slate-500 text-[10px] uppercase font-bold mb-1">Mediana</p>
                                <p class="text-xl font-bold text-slate-200">${formatValue(data.envido_median, 0)}</p>
                            </div>
                            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/30">
                                <p class="text-slate-500 text-[10px] uppercase font-bold mb-1">Max</p>
                                <p class="text-xl font-bold text-emerald-400 font-mono">${data.envido_max || 0}</p>
                            </div>
                            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/30">
                                <p class="text-slate-500 text-[10px] uppercase font-bold mb-1">Min</p>
                                <p class="text-xl font-bold text-red-400 font-mono">${data.envido_min || 0}</p>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        `;
    }

    function initMatrix() {
        const ranks = ["1e", "1b", "7e", "7o", "3", "2", "1f", "12", "11", "10", "7f", "6", "5", "4"];
        const matrix = document.getElementById('matrix');
        matrix.innerHTML = ''; // Clear existing matrix

        const baseCellClass = 'p-1 flex items-start justify-start font-medium cursor-pointer transition-all duration-200 select-none aspect-[2/1] relative leading-tight uppercase text-[12px]';
        const hoverEffects = 'hover:scale-105 hover:z-10 hover:shadow-lg';
        const activeEffects = 'active:scale-95';

        const config = METRIC_CONFIGS[currentMetric];

        ranks.forEach((rowRank, i) => {
            ranks.forEach((colRank, j) => {
                if (!showFullMatrix && j > i) return;

                const cell = document.createElement('div');
                const cellClasses = `${baseCellClass} ${activeEffects}`;

                // Force grid position to keep layout correct even when cells are missing
                cell.style.gridRow = i + 1;
                cell.style.gridColumn = j + 1;

                if (i === j && ["1e", "1b", "7e", "7o"].includes(rowRank)) {
                    cell.className = `${baseCellClass} bg-slate-700 text-slate-400 cursor-default`;
                    cell.textContent = rowRank;
                } else {
                    let key = `${rowRank} ${colRank} ${j > i}`;
                    let data = pairStats[key];
                    if (!data) {
                        key = `${colRank} ${rowRank} ${j > i}`;
                        data = pairStats[key];
                    }
                    if (data) {
                        const isEnvido = data.is_envido;
                        const val = data[config.key];

                        const bgColor = getColorForScore(val, config.range);

                        cell.className = `${cellClasses} ${hoverEffects}`;
                        cell.style.backgroundColor = bgColor;
                        cell.style.color = 'rgb(15, 23, 42)';

                        if (isEnvido) {
                            cell.innerHTML = `${rowRank}<br>${colRank}`;
                        } else {
                            cell.innerHTML = `${colRank}<br>${rowRank}`;
                        }

                        cell.onmouseover = () => {
                            // Highlight selection
                            document.querySelectorAll('#matrix > div').forEach(c => {
                                c.style.outline = 'none';
                                c.style.zIndex = '0';
                            });
                            cell.style.outline = '2px solid white';
                            cell.style.outlineOffset = '-2px';
                            cell.style.zIndex = '20';
                            updateStatsPanel(key, isEnvido);
                        };
                    } else {
                        cell.className = `${baseCellClass} bg-slate-700 text-slate-400 cursor-default`;
                        cell.innerHTML = `${rowRank}<br>${colRank}`;
                    }
                }
                matrix.appendChild(cell);
            });
        });
    }

    // Initial load from template data
    updateMatrixStats({{ . }});
</script>
{{ end }}