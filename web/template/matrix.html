{{ define "matrix" }}
<div class="flex flex-col items-center w-full max-w-xl">
    <div class="flex justify-between items-center w-full mb-6">
        <div class="flex flex-wrap gap-2 p-1.5 bg-slate-800/80 rounded-xl border border-slate-700/50 backdrop-blur-md">
            <button onclick="setMetric('combined_mean')" id="btn-combined_score"
                class="metric-btn px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all duration-200">
                Fuerza
            </button>
            <button onclick="setMetric('truco_mean')" id="btn-truco_mean"
                class="metric-btn px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all duration-200">
                Truco
            </button>
            <button onclick="setMetric('envido_mean')" id="btn-envido_mean"
                class="metric-btn px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all duration-200">
                Envido
            </button>
            <button onclick="setMetric('count')" id="btn-count"
                class="metric-btn px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all duration-200">
                Manos
            </button>
        </div>

        <div class="flex items-center gap-3 bg-slate-800/80 p-1.5 rounded-xl border border-slate-700/50 h-fit">
            <button onclick="toggleMatrix()" id="envido-toggle" hx-get="/track-stats"
                hx-vals='js:{state: window.currentTrucoState, fmatrix: showFullMatrix}' hx-trigger="click"
                hx-swap="none" hx-on::after-request="updateMatrixStats(JSON.parse(event.detail.xhr.response))"
                class="relative inline-flex h-6 w-11 items-center rounded-full transition-all duration-300 bg-blue-600">
                <span id="envido-toggle-dot"
                    class="inline-block h-4 w-4 transform rounded-full bg-slate-200 transition-all duration-300 translate-x-6"></span>
            </button>
            <span id="label-com"
                class="text-[10px] font-bold tracking-widest text-blue-400 pr-2 transition-colors duration-300">
                COMPLETA 14x14
            </span>
        </div>
    </div>

    <div class="grid grid-cols-[repeat(14,minmax(0,1fr))] gap-px bg-slate-900 border border-slate-900 rounded-lg overflow-hidden shadow-2xl w-full"
        id="matrix">
    </div>
</div>

<script>
    let pairStats = {};
    let currentMetric = 'combined_mean';
    let showFullMatrix = true;

    function toggleMatrix() {
        showFullMatrix = !showFullMatrix;
        const toggle = document.getElementById('envido-toggle');
        const dot = document.getElementById('envido-toggle-dot');
        const textLabel = document.getElementById('label-com');

        if (showFullMatrix) {
            toggle.classList.remove('bg-slate-700');
            toggle.classList.add('bg-blue-600');
            dot.classList.remove('translate-x-1');
            dot.classList.add('translate-x-6');
            textLabel.classList.add('text-blue-400');
            textLabel.classList.remove('text-slate-400');
            textLabel.innerText = 'COMPLETA 14x14';
        } else {
            toggle.classList.remove('bg-blue-600');
            toggle.classList.add('bg-slate-700');
            dot.classList.remove('translate-x-6');
            dot.classList.add('translate-x-1');
            textLabel.classList.remove('text-blue-400');
            textLabel.classList.add('text-slate-400');
            textLabel.innerText = 'TRIANGULO 14x14';
        }
        initMatrix();
    }

    const COLOR_CONFIG = {
        lowScore: [60, 70, 90],
        highScore: [220, 85, 45],
    };

    function setMetric(metric) {
        currentMetric = metric;
        // Update button styles
        document.querySelectorAll('.metric-btn').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-900/40');
            btn.classList.add('text-slate-400', 'hover:text-slate-200', 'hover:bg-slate-700/50');
        });
        const activeBtn = document.getElementById('btn-' + metric);
        if (activeBtn) {
            activeBtn.classList.remove('text-slate-400', 'hover:text-slate-200', 'hover:bg-slate-700/50');
            activeBtn.classList.add('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-900/40');
        }
        initMatrix();
    }

    // score: value to map color to
    // range: max value score can have
    //   If score is not evenly distributed try with higher or lower range,
    //   or pass 1 if value is already normalized
    function getColorForScore(score, range) {
        if (score === undefined || isNaN(score)) {
            return 'hsl(220,15%,30%)';
        }
        const [h1, s1, l1] = COLOR_CONFIG.lowScore;
        const [h2, s2, l2] = COLOR_CONFIG.highScore;
        const t = Math.min(Math.max(score / range, 0), 1);
        const h = h1 + (h2 - h1) * t;
        const s = s1 + (s2 - s1) * t;
        const l = l1 + (l2 - l1) * t;
        return `hsl(${h},${s}%,${l}%)`;
    }

    function updateMatrixStats(newStats) {
        if (!newStats) return;
        pairStats = newStats;
        setMetric(currentMetric);
    }

    function formatValue(val, precision = 2) {
        if (val === undefined || isNaN(val)) return 'N/A';
        return val.toFixed(precision);
    }

    function updateStatsPanel(data, key) {
        const placeholder = document.getElementById('stats-placeholder');
        const content = document.getElementById('stats-content');

        if (!data) {
            placeholder.classList.remove('hidden');
            content.classList.add('hidden');
            return;
        }

        placeholder.classList.add('hidden');
        content.classList.remove('hidden');

        const [c1, c2] = key.split(' ');

        // Update basic info
        document.getElementById('stats-card1').textContent = c1;
        document.getElementById('stats-card2').textContent = c2;
        document.getElementById('stats-count').textContent = `${data.count} manos posibles`;
        document.getElementById('stats-combined').textContent = formatValue(data.combined_mean, 3);

        // Update Truco section
        document.getElementById('stats-truco-mean').textContent = formatValue(data.truco_mean, 3);
        document.getElementById('stats-truco-median').textContent = formatValue(data.truco_median, 3);
        document.getElementById('stats-truco-max').textContent = formatValue(data.truco_max, 3);
        document.getElementById('stats-truco-min').textContent = formatValue(data.truco_min, 3);

        // Update Envido section
        document.getElementById('stats-envido-mean').textContent = formatValue(data.envido_mean, 1);
        document.getElementById('stats-envido-median').textContent = formatValue(data.envido_median, 0);
        document.getElementById('stats-envido-max').textContent = data.envido_max || 0;
        document.getElementById('stats-envido-min').textContent = data.envido_min || 0;
    }

    function initMatrix() {
        const ranks = ["1e", "1b", "7e", "7o", "3", "2", "1f", "12", "11", "10", "7f", "6", "5", "4"];
        const matrix = document.getElementById('matrix');
        matrix.innerHTML = '';

        const baseCellClass = 'p-1 flex items-start justify-start font-medium cursor-pointer transition-all duration-200 select-none aspect-[1.1/0.5] relative leading-tight uppercase text-[14px]';
        const emptyCellClass = 'bg-slate-700 text-slate-400 cursor-default';

        const metrics = Object.values(pairStats).map(item => item[currentMetric]);
        const cRange = Math.max(...metrics);

        ranks.forEach((rowRank, i) => {
            ranks.forEach((colRank, j) => {
                if (!showFullMatrix && j > i) return;

                const cell = document.createElement('div');
                cell.className = `${baseCellClass} col-start-[${j + 1}] row-start-[${i + 1}]`;

                const isDiag = i === j;
                const isTopFigure = ["1e", "1b", "7e", "7o"].includes(rowRank);

                if (isDiag && isTopFigure) {
                    cell.classList.add(...emptyCellClass.split(' '));
                    cell.innerHTML = `${rowRank}<br>&nbsp;`;
                } else {
                    const key = `${rowRank} ${colRank} ${j > i}`;
                    const data = pairStats[key] || pairStats[`${colRank} ${rowRank} ${j > i}`];

                    if (data) {
                        const val = data[currentMetric];
                        const bgColor = getColorForScore(val, cRange);

                        cell.classList.add(`bg-[${bgColor}]`, 'hover:scale-105', 'hover:z-10', 'hover:shadow-lg', 'active:scale-95', 'text-slate-900');

                        cell.innerHTML = data.is_envido ? `${rowRank}<br>${colRank}` : `${colRank}<br>${rowRank}`;

                        cell.onmouseover = () => {
                            document.querySelectorAll('#matrix > div').forEach(c => {
                                c.classList.remove('outline', 'outline-2', 'outline-white', 'outline-offset-[-2px]', 'z-20');
                            });
                            cell.classList.add('outline', 'outline-2', 'outline-white', 'outline-offset-[-2px]', 'z-20');
                            updateStatsPanel(data, key);
                        };
                    } else {
                        cell.classList.add(...emptyCellClass.split(' '));
                        cell.innerHTML = `${rowRank}<br>${colRank}`;
                    }
                }
                matrix.appendChild(cell);
            });
        });
    }

    // TODO check if this is not needed
    // window.currentTrucoState = "{{ . }}"
    // updateMatrixStats(JSON.parse(window.currentTrucoState));
</script>
{{ end }}