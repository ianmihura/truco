{{ define "matrix" }}
<div class="grid grid-cols-[repeat(14,minmax(0,1fr))] gap-px bg-slate-900 border border-slate-900 rounded-lg overflow-hidden shadow-2xl max-w-5xl w-full"
    id="matrix">
    <!-- JS will populate this -->
</div>

<script>
    let pairStats = {};
    let currentSelectedKey = null;

    const COLOR_CONFIG = {
        lowScore: [25, 85, 40],
        highScore: [90, 85, 50],
        textThreshold: 0.6
    };

    // score: value to map color to
    // range: max value score can have
    //   If score is not evenly distributed try with higher or lower range,
    //   or pass 1 if value is already normalized
    function getColorForScore(score, range) {
        if (score === undefined || isNaN(score)) {
            return 'hsl(220, 15%, 30%)';
        }
        const [h1, s1, l1] = COLOR_CONFIG.lowScore;
        const [h2, s2, l2] = COLOR_CONFIG.highScore;
        const t = score / range;
        const h = h1 + (h2 - h1) * t;
        const s = s1 + (s2 - s1) * t;
        const l = l1 + (l2 - l1) * t;
        return `hsl(${h}, ${s}%, ${l}%)`;
    }

    async function loadStats() {
        try {
            const response = await fetch('/static/pair_stats.csv');
            const csvText = await response.text();
            const lines = csvText.trim().split('\n');
            const header = lines[0].split(',');

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const data = {};
                header.forEach((col, index) => {
                    if (index === 0) {
                        data[col] = values[index]
                    } else if (col === 'is_envido') {
                        data[col] = values[index]
                    } else {
                        data[col] = parseFloat(values[index]);
                    }
                });
                if (data.pair) {
                    pairStats[data.pair + ' ' + data.is_envido] = data;
                }
            }
            initMatrix();
        } catch (error) {
            console.error('Failed to load pair strengths:', error);
        }
    }

    function formatValue(val, precision = 2) {
        if (val === undefined || isNaN(val)) return 'N/A';
        return val.toFixed(precision);
    }

    function updateStatsPanel(key, isEnvido) {
        const data = pairStats[key];
        const placeholder = document.getElementById('stats-placeholder');
        const content = document.getElementById('stats-content');

        if (!data) {
            placeholder.classList.remove('hidden');
            content.classList.add('hidden');
            return;
        }

        placeholder.classList.add('hidden');
        content.classList.remove('hidden');

        const [c1, c2, env] = key.split(' ');

        content.innerHTML = `
            <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden shadow-xl animate-in fade-in slide-in-from-right-4 duration-300">
                <div class="bg-gradient-to-r from-blue-600/20 to-emerald-600/20 p-6 border-b border-slate-700">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-slate-400 text-xs font-bold uppercase tracking-wider">Mejor par</span>
                        <span class="bg-slate-700 text-slate-300 text-[10px] px-2 py-0.5 rounded-full font-mono">${data.count} manos posibles</span>
                    </div>
                    <h2 class="text-4xl font-black text-white flex items-center gap-3 mb-3">
                        ${c1}<span class="text-slate-500 font-light">&</span>${c2}
                    </h2>
                    <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/30">
                        <p class="text-slate-500 text-[10px] uppercase font-bold mb-1">Resumen (envido y truco)</p>
                        <p class="text-xl font-bold text-slate-200">${formatValue(data.combined_mean, 3)}</p>
                    </div>
                </div>
                
                <div class="p-6 space-y-6">
                    <section>
                        <h3 class="text-blue-400 text-xs font-bold uppercase tracking-widest mb-4 flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span>
                            Truco
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/30">
                                <p class="text-slate-500 text-[10px] uppercase font-bold mb-1">Promedio</p>
                                <p class="text-xl font-bold text-slate-200">${formatValue(data.truco_mean, 3)}</p>
                            </div>
                            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/30">
                                <p class="text-slate-500 text-[10px] uppercase font-bold mb-1">Mediana</p>
                                <p class="text-xl font-bold text-slate-200">${formatValue(data.truco_median, 3)}</p>
                            </div>
                            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/30">
                                <p class="text-slate-500 text-[10px] uppercase font-bold mb-1">Max</p>
                                <p class="text-xl font-bold text-emerald-400">${formatValue(data.truco_max, 3)}</p>
                            </div>
                            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/30">
                                <p class="text-slate-500 text-[10px] uppercase font-bold mb-1">Min</p>
                                <p class="text-xl font-bold text-red-400">${formatValue(data.truco_min, 3)}</p>
                            </div>
                        </div>
                    </section>

                    <!-- Divider -->
                    <div class="border-t border-slate-700/50"></div>

                    <section>
                        <h3 class="text-emerald-400 text-xs font-bold uppercase tracking-widest mb-4 flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                            Envido
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/30">
                                <p class="text-slate-500 text-[10px] uppercase font-bold mb-1">Promedio</p>
                                <p class="text-xl font-bold text-slate-200">${formatValue(data.envido_mean, 1)}</p>
                            </div>
                            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/30">
                                <p class="text-slate-500 text-[10px] uppercase font-bold mb-1">Mediana</p>
                                <p class="text-xl font-bold text-slate-200">${formatValue(data.envido_median, 0)}</p>
                            </div>
                            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/30">
                                <p class="text-slate-500 text-[10px] uppercase font-bold mb-1">Max</p>
                                <p class="text-xl font-bold text-emerald-400 font-mono">${data.envido_max || 0}</p>
                            </div>
                            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/30">
                                <p class="text-slate-500 text-[10px] uppercase font-bold mb-1">Min</p>
                                <p class="text-xl font-bold text-red-400 font-mono">${data.envido_min || 0}</p>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        `;
    }

    function initMatrix() {
        const ranks = [
            "1e",
            "1b",
            "7e",
            "7o",
            "3",
            "2",
            "1f",
            "12",
            "11",
            "10",
            "7f",
            "6",
            "5",
            "4"
        ];
        const matrix = document.getElementById('matrix');

        const baseCellClass = 'p-1 flex items-start justify-start font-medium cursor-pointer transition-all duration-200 select-none aspect-[2/1] relative leading-tight uppercase text-[12px]';
        const hoverEffects = 'hover:scale-105 hover:z-10 hover:shadow-lg';
        const activeEffects = 'active:scale-95';

        ranks.forEach((rowRank, i) => {
            ranks.forEach((colRank, j) => {
                const cell = document.createElement('div');
                const cellClasses = `${baseCellClass} ${activeEffects}`;

                if (i === j && ["1e", "1b", "7e", "7o"].includes(rowRank)) {
                    cell.className = `${baseCellClass} bg-slate-700 text-slate-400 cursor-default`;
                    cell.textContent = rowRank;
                } else {
                    let key = `${rowRank} ${colRank} ${j > i}`;
                    let data = pairStats[key];
                    if (!data) {
                        key = `${colRank} ${rowRank} ${j > i}`;
                        data = pairStats[key];
                    }
                    if (data) {
                        console.log(data)
                        const isEnvido = data.is_envido;
                        const val = data.combined_mean;

                        // let val;
                        // if (isEnvido) {
                        //     val = data.truco_mean;
                        // } else {
                        //     val = data.truco_mean;
                        // }

                        const bgColor = getColorForScore(val, 1);

                        cell.className = `${cellClasses} ${hoverEffects}`;
                        cell.style.backgroundColor = bgColor;
                        cell.style.color = 'rgb(15, 23, 42)';

                        if (isEnvido) {
                            cell.innerHTML = `${rowRank}<br>${colRank}`;
                        } else {
                            cell.innerHTML = `${colRank}<br>${rowRank}`;
                        }

                        cell.onclick = () => {
                            // Highlight selection (optional enhancement)
                            document.querySelectorAll('#matrix > div').forEach(c => c.style.outline = 'none');
                            cell.style.outline = '2px solid white';
                            cell.style.outlineOffset = '-2px';
                            updateStatsPanel(key, isEnvido);
                        };
                    } else {
                        cell.className = `${baseCellClass} bg-slate-700 text-slate-400 cursor-default`;
                        cell.innerHTML = `${rowRank}<br>${colRank}`;
                    }
                }
                matrix.appendChild(cell);
            });
        });
    }

    loadStats();
</script>
{{ end }}